<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Add EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("g4dU-gdpiGoL3yIER");
        })();
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-purple-500">Admin Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span class="text-lg">Admin Panel</span>
                <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center">
                    <span>A</span>
                </div>
            </div>
        </div>

        <!-- User Selection Section -->
        <div class="max-w-4xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6 text-center">Select User</h2>
            
            <div class="flex items-center space-x-4 mb-4">
                <select 
                    id="user-selector" 
                    class="flex-grow bg-gray-700 text-white p-3 rounded-lg"
                >
                    <option value="">Loading users...</option>
                </select>
                <button 
                    id="load-user-data" 
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition"
                >
                    Load User
                </button>
            </div>
            
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-400">
                    <span id="user-count">0</span> registered users found
                </div>
                <button 
                    id="refresh-users" 
                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm"
                >
                    Refresh List
                </button>
            </div>
        </div>

        <div class="max-w-4xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-6 text-center">User Information</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">User ID</label>
                        <input 
                            type="text" 
                            id="user-id" 
                            class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                            value="USR123456"
                            readonly
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">User Name</label>
                        <input 
                            type="text" 
                            id="full-name" 
                            class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                            value="Charles Crowther"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">User Email</label>
                        <input 
                            type="email" 
                            id="email" 
                            class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                            value="charlescrowther@example.com"
                        >
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-6 text-center">Account Balances</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Account Balance (USD)</label>
                        <input 
                            type="number" 
                            id="account-balance" 
                            class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                            value="25000.00"
                            step="0.01"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Total Withdraw (USD)</label>
                        <input 
                            type="number" 
                            id="total-withdraw" 
                            class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                            value="0.00"
                            step="0.01"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Total Deposit (USD)</label>
                        <input 
                            type="number" 
                            id="total-deposit" 
                            class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                            value="0.00"
                            step="0.01"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Total Invest (USD)</label>
                        <input 
                            type="number" 
                            id="total-invest" 
                            class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                            value="2500.00"
                            step="0.01"
                        >
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-6 text-center">Investment Plan</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Plan Name</label>
                        <input 
                            type="text" 
                            id="plan-name" 
                            class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                            value="Gold Plan"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ROI Percentage</label>
                        <div class="flex">
                            <input 
                                type="number" 
                                id="roi-percentage" 
                                class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                                value="20.00"
                                step="0.01"
                            >
                            <span class="bg-gray-700 text-white p-3 rounded-r-lg">%</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Minimum (USD)</label>
                            <input 
                                type="number" 
                                id="plan-min" 
                                class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                                value="1000.00"
                                step="0.01"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Maximum (USD)</label>
                            <input 
                                type="number" 
                                id="plan-max" 
                                class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                                value="2500.00"
                                step="0.01"
                            >
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Duration</label>
                        <select id="plan-duration" class="w-full bg-gray-700 text-white p-3 rounded-lg">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Every week</option>
                            <option value="biweekly">Every 2 weeks</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-6 text-center">Referral Program</h2>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Referral Earnings (USD)</label>
                    <input 
                        type="number" 
                        id="referral-earnings" 
                        class="w-full bg-gray-700 text-white p-3 rounded-lg" 
                        value="0.00"
                        step="0.01"
                    >
                </div>
            </div>

            <div class="flex justify-between">
                <div id="debug-status" class="text-green-400"></div>
                <div class="flex space-x-4">
                    <button 
                        id="save-changes" 
                        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition"
                    >
                        Save Changes
                    </button>
                    <button 
                        id="notify-user" 
                        class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition"
                    >
                        Notify User
                    </button>
                </div>
            </div>
            
            <!-- Debug panel -->
            <div class="mt-8 p-4 bg-gray-700 rounded-lg" id="debug-panel">
                <h3 class="text-lg font-bold mb-2">Debug Panel</h3>
                <div id="debug-output" class="bg-gray-800 p-3 rounded-lg text-sm font-mono max-h-40 overflow-y-auto">
                    Waiting for actions...
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import {
          getFirestore,
          doc,
          setDoc,
          getDoc,
          collection,
          getDocs,
          query
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
      
        const firebaseConfig = {
          apiKey: "AIzaSyCWuFq3ZYhLdjVrKKa7RH2_T_f1Ct4rtIY",
          authDomain: "invest-6c18d.firebaseapp.com",
          projectId: "invest-6c18d",
          storageBucket: "invest-6c18d.firebasestorage.app",
          messagingSenderId: "401038787144",
          appId: "1:401038787144:web:949e93e8ff282fdd294e7d",
          measurementId: "G-GL5QZ99F5F"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
      
        function addDebug(msg) {
          const debugBox = document.getElementById("debug-output");
          const time = new Date().toLocaleTimeString();
          const entry = document.createElement("div");
          entry.textContent = `[${time}] ${msg}`;
          debugBox.appendChild(entry);
          debugBox.scrollTop = debugBox.scrollHeight;
          console.log(`[${time}] ${msg}`);
        }
      
        function showStatus(msg, success = true) {
          const el = document.getElementById("debug-status");
          el.textContent = msg;
          el.className = success ? "text-green-500" : "text-red-500";
          setTimeout(() => (el.textContent = ""), 3000);
        }
      
        async function fetchUsers() {
          try {
            const snapshot = await getDocs(query(collection(db, "dashboards")));
            const users = [];
            snapshot.forEach((docSnap) => {
              const data = docSnap.data();
              users.push({
                id: data.userId || docSnap.id,
                fullName: data.fullName || "Unknown",
                email: data.email || "unknown@example.com"
              });
            });
            addDebug(`Fetched ${users.length} users`);
            return users;
          } catch (error) {
            addDebug("Error fetching users: " + error.message);
            showStatus("Failed to load users", false);
            return [];
          }
        }
      
        async function populateDropdown() {
          const dropdown = document.getElementById("user-selector");
          dropdown.innerHTML = '<option value="">Loading...</option>';
          const users = await fetchUsers();
          document.getElementById("user-count").textContent = users.length;
      
          if (users.length === 0) {
            dropdown.innerHTML = '<option value="">No users found</option>';
            return;
          }
      
          dropdown.innerHTML = '<option value="">Select a user</option>';
          users.forEach((user) => {
            const opt = document.createElement("option");
            opt.value = user.id;
            opt.textContent = `${user.fullName}`;
            opt.dataset.email = user.email;
            dropdown.appendChild(opt);
          });
        }
      
        async function loadUserData(userId) {
          try {
            const docRef = doc(db, "dashboards", userId);
            const docSnap = await getDoc(docRef);
      
            if (!docSnap.exists()) {
              showStatus("User data not found", false);
              return false;
            }
      
            const data = docSnap.data();
      
            document.getElementById("user-id").value = data.userId || "";
            document.getElementById("full-name").value = data.fullName || "";
            document.getElementById("email").value = data.email || "";
      
            document.getElementById("account-balance").value = data.accountBalance?.toFixed(2) || "0.00";
            document.getElementById("investment-total").value = data.investmentTotal?.toFixed(2) || "0.00";
            document.getElementById("total-deposit").value = data.totalDeposit?.toFixed(2) || "0.00";
            document.getElementById("total-display").value = data.totalDisplay?.toFixed(2) || "0.00";
            document.getElementById("total-referral").value = data.totalReferral?.toFixed(2) || "0.00";
      
            showStatus("User data loaded");
            return true;
          } catch (err) {
            addDebug("Error loading user data: " + err.message);
            showStatus("Load failed", false);
            return false;
          }
        }
      
        async function saveUserData() {
          const userId = document.getElementById("user-id").value;
          if (!userId) {
            showStatus("User ID is required", false);
            throw new Error("Missing user ID");
          }
      
          const updatedData = {
            userId,
            fullName: document.getElementById("full-name").value,
            email: document.getElementById("email").value,
            accountBalance: parseFloat(document.getElementById("account-balance").value),
            investmentTotal: parseFloat(document.getElementById("investment-total").value),
            totalDeposit: parseFloat(document.getElementById("total-deposit").value),
            totalDisplay: parseFloat(document.getElementById("total-display").value),
            totalReferral: parseFloat(document.getElementById("total-referral").value),
            lastUpdated: new Date().toISOString()
          };
      
          await setDoc(doc(db, "dashboards", userId), updatedData);
          showStatus("Changes saved");
          addDebug("User data updated in Firestore");
      
          return updatedData;
        }
      
        document.getElementById("load-user-data").addEventListener("click", async () => {
          const selectedUserId = document.getElementById("user-selector").value;
          if (!selectedUserId) {
            showStatus("Select a user first", false);
            return;
          }
          await loadUserData(selectedUserId);
        });
      
        document.getElementById("refresh-users").addEventListener("click", populateDropdown);
      
        document.getElementById("save-changes").addEventListener("click", saveUserData);
      
        document.getElementById("notify-user").addEventListener("click", async () => {
          try {
            const data = await saveUserData();
            const btn = document.getElementById("notify-user");
            btn.disabled = true;
            btn.textContent = "Sending...";
      
            const templateParams = {
              to_email: data.email,
              name: data.fullName,
              title: "Account Update",
              account_balance: data.accountBalance.toFixed(2),
              investment_total: data.investmentTotal.toFixed(2),
              total_deposit: data.totalDeposit.toFixed(2),
              total_display: data.totalDisplay.toFixed(2),
              total_referral: data.totalReferral.toFixed(2),
              message: "Your account has been successfully updated."
            };
      
            await emailjs.send(
              "service_538bgur",
              "template_zzwo3cj",
              templateParams,
              "g4dU-gdpiGoL3yIER"
            );
      
            showStatus("Notification sent");
            addDebug("Email sent to user");
          } catch (err) {
            addDebug("Email error: " + err.message);
            showStatus("Failed to notify user", false);
          } finally {
            const btn = document.getElementById("notify-user");
            btn.disabled = false;
            btn.textContent = "Notify User";
          }
        });
      
        document.querySelectorAll("input").forEach((el) => {
          el.addEventListener("input", () => {
            showStatus("Unsaved changes", false);
          });
        });
      
        document.addEventListener("DOMContentLoaded", async () => {
          addDebug("Page ready");
          await populateDropdown();
          const dropdown = document.getElementById("user-selector");
          if (dropdown.options.length > 1) {
            dropdown.selectedIndex = 1;
            await loadUserData(dropdown.value);
          }
        });
      </script>            
</body>
</html>